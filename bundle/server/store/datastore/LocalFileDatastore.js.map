{"version":3,"sources":["../../../../server/store/datastore/LocalFileDatastore.js"],"names":["LocalFileDataStore","path","key","Promise","resolve","reject","readFile","formatFilePath","err","data","writeFile","the_path","dir","dirname","prefix","basename","readdir","files","keys","map","file","re","RegExp","m","exec","push","unlink"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AAEA;;;;;;;;;;;;IAEqBA,kB;;;AAEnB,gCAAc;AAAA;;AAAA;AAEb;;;;mCAEcC,I,EAAMC,G,EAAK;AACxB,aAAUD,IAAV,SAAkBC,GAAlB;AACD;;AAED;;;;0BACMD,I,EAAMC,G,EAAK;AAAA;;AACf,aAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,qBAAGC,QAAH,CAAY,OAAKC,cAAL,CAAoBN,IAApB,EAA0BC,GAA1B,CAAZ,EAA4C,UAACM,GAAD,EAAMC,IAAN,EAAe;AACzD,cAAID,GAAJ,EAAS;AACPH,mBAAOG,GAAP;AACD,WAFD,MAEO;AACLJ,oBAAQK,IAAR;AACD;AACF,SAND;AAOD,OARM,CAAP;AASD;;AAED;;;;2BACOR,I,EAAMC,G,EAAKO,I,EAAM;AAAA;;AACtB,aAAO,IAAIN,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,qBAAGK,SAAH,CAAa,OAAKH,cAAL,CAAoBN,IAApB,EAA0BC,GAA1B,CAAb,EAA6CO,IAA7C,EAAmD,UAACD,GAAD,EAAS;AAC1D,cAAIA,GAAJ,EAAS;AACPH,mBAAOG,GAAP;AACD,WAFD,MAEO;AACLJ;AACD;AACF,SAND;AAOD,OARM,CAAP;AASD;;;0BAEKO,Q,EAAU;AACd,UAAIC,MAAM,eAAKC,OAAL,CAAaF,QAAb,CAAV;AACA,UAAIG,SAAS,eAAKC,QAAL,CAAcJ,QAAd,CAAb;AACA,aAAO,IAAIR,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,qBAAGW,OAAH,CAAWJ,GAAX,EAAgB,UAACJ,GAAD,EAAMS,KAAN,EAAgB;AAC9B,cAAIT,GAAJ,EAAS;AACPH,mBAAOG,GAAP;AACD,WAFD,MAEO;AACL,gBAAIU,OAAO,EAAX;AACAD,kBAAME,GAAN,CAAU,UAACC,IAAD,EAAU;AAClB,kBAAIC,KAAK,IAAIC,MAAJ,CAAWR,SAAS,eAApB,EAAqC,GAArC,CAAT;AACA,kBAAIS,IAAIF,GAAGG,IAAH,CAAQJ,IAAR,CAAR;AACA,kBAAIG,CAAJ,EAAO;AACLL,qBAAKO,IAAL,CAAUF,EAAE,CAAF,CAAV;AACD;AACF,aAND;AAOAnB,oBAAQc,IAAR;AACD;AACF,SAdD;AAeD,OAhBM,CAAP;AAiBD;;;yBAEIjB,I,EAAMC,G,EAAK;AAAA;;AACd,aAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,qBAAGqB,MAAH,CAAU,OAAKnB,cAAL,CAAoBN,IAApB,EAA0BC,GAA1B,CAAV,EAA0C,UAACM,GAAD,EAAS;AACjD,cAAIA,GAAJ,EAAS;AACPH,mBAAOG,GAAP;AACD,WAFD,MAEO;AACLJ;AACD;AACF,SAND;AAOD,OARM,CAAP;AASD;;;;;;kBApEkBJ,kB","file":"LocalFileDatastore.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\n\nimport DataStore from './DataStore';\n\nexport default class LocalFileDataStore extends DataStore {\n\n  constructor() {\n    super();\n  }\n\n  formatFilePath(path, key) {\n    return `${path}_${key}.json`;\n  }\n\n  // Override\n  _read(path, key) {\n    return new Promise((resolve, reject) => {\n      fs.readFile(this.formatFilePath(path, key), (err, data) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(data);\n        }\n      });\n    });\n  }\n\n  // Override\n  _write(path, key, data) {\n    return new Promise((resolve, reject) => {\n      fs.writeFile(this.formatFilePath(path, key), data, (err) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n\n  _scan(the_path) {\n    let dir = path.dirname(the_path);\n    let prefix = path.basename(the_path);\n    return new Promise((resolve, reject) => {\n      fs.readdir(dir, (err, files) => {\n        if (err) {\n          reject(err);\n        } else {\n          let keys = [];\n          files.map((file) => {\n            let re = new RegExp(prefix + '_([^_]+).json', 'g');\n            let m = re.exec(file);\n            if (m) {\n              keys.push(m[1]);\n            }\n          });\n          resolve(keys);\n        }\n      });\n    });\n  }\n\n  _del(path, key) {\n    return new Promise((resolve, reject) => {\n      fs.unlink(this.formatFilePath(path, key), (err) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n}\n"]}