{"version":3,"sources":["../../../server/helper/FBGraphHelper.js"],"names":["url","FBGraphHelper","params","access_token","FB_APP_ACCESS_TOKEN","app_domains","parse","HEROKU_APP_URL","hostname","website_url","info","JSON","stringify","post","uri","GRAPH_BASE_URL","FB_APP_ID","json","then","_body","catch","err","error","stack","page","options","object","callback_url","WEBHOOK_PATH","fields","verify_token","WEBHOOK_VERIFY_TOKEN","id"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;IAAYA,G;;;;;;;;IAESC,a;;;;;;;oCAEI;AACrB,UAAIC,SAAS;AACXC,sBAAc,mBAASC,mBADZ;AAEXC,qBAAa,CAACL,IAAIM,KAAJ,CAAU,mBAASC,cAAnB,EAAmCC,QAApC,CAFF;AAGXC,qBAAa,mBAASF;AAHX,OAAb;AAKA,uBAAOG,IAAP,6BAAsC,mBAASH,cAA/C,qBAA6EI,KAAKC,SAAL,CAAeV,MAAf,CAA7E;AACA,aAAO,oBAAUW,IAAV,CAAe;AACpBC,aAAQ,mBAASC,cAAjB,SAAmC,mBAASC,SADxB;AAEpBC,cAAMf;AAFc,OAAf,EAINgB,IAJM,CAID,UAACC,KAAD,EAAW;AACf,yBAAOT,IAAP,CAAY,iBAAZ;AACD,OANM,EAONU,KAPM,CAOA,UAACC,GAAD,EAAS;AACd,yBAAOC,KAAP,kCAA4CD,GAA5C;AACA,YAAIA,IAAIE,KAAR,EAAe;AACb,2BAAOD,KAAP,CAAaD,IAAIE,KAAjB;AACD;AACD,eAAOF,GAAP;AACD,OAbM,CAAP;AAcD;;;sCAEwBG,I,EAAM;AAC7B,UAAIC,UAAU;AACZX,aAAQ,mBAASC,cAAjB,SAAmC,mBAASC,SAA5C,mBADY;AAEZC,cAAM;AACJd,wBAAc,mBAASC,mBADnB;AAEJsB,kBAAQ,MAFJ;AAGJC,wBAAc,mBAASpB,cAAT,GAA0B,mBAASqB,YAH7C;AAIJC,kBAAQ,CAAC,UAAD,EAAa,qBAAb,CAJJ;AAKJC,wBAAc,mBAASC;AALnB;AAFM,OAAd;AAUA,uBAAOrB,IAAP,8CAAuDC,KAAKC,SAAL,CAAea,QAAQR,IAAvB,CAAvD;;AAEA,aAAO,oBAAUJ,IAAV,CAAeY,OAAf,EACJP,IADI,CACC,UAACC,KAAD,EAAW;AACf,yBAAOT,IAAP,CAAY,wCAAZ;AACA,YAAIR,SAAS;AACXC,wBAAcqB,KAAKrB;AADR,SAAb;AAGA,yBAAOO,IAAP,2CAAoDC,KAAKC,SAAL,CAAeV,MAAf,CAApD;AACA,eAAO,oBAAUW,IAAV,CAAe;AACpBC,eAAQ,mBAASC,cAAjB,SAAmCS,KAAKQ,EAAxC,qBADoB;AAEpBf,gBAAMf;AAFc,SAAf,CAAP;AAID,OAXI,EAYJgB,IAZI,CAYC,UAACC,KAAD,EAAW;AACf,yBAAOT,IAAP,CAAY,qCAAZ;AACD,OAdI,EAeJU,KAfI,CAeE,UAACC,GAAD,EAAS;AACd,yBAAOC,KAAP,wCAAkDX,KAAKC,SAAL,CAAeS,GAAf,CAAlD;AACA,eAAOA,GAAP;AACD,OAlBI,CAAP;AAmBD;;;;;;kBAzDkBpB,a","file":"FBGraphHelper.js","sourcesContent":["import constant from 'common/constant';\nimport logger from 'common/logger';\nimport fbrequest from 'common/fbrequest';\nimport * as url from 'url';\n\nexport default class FBGraphHelper {\n\n  static setWebsiteURL() {\n    let params = {\n      access_token: constant.FB_APP_ACCESS_TOKEN,\n      app_domains: [url.parse(constant.HEROKU_APP_URL).hostname],\n      website_url: constant.HEROKU_APP_URL,\n    };\n    logger.info(`Setting Website URL to ${constant.HEROKU_APP_URL} with param: ${JSON.stringify(params)}`);\n    return fbrequest.post({\n      uri: `${constant.GRAPH_BASE_URL}/${constant.FB_APP_ID}`,\n      json: params,\n    })\n    .then((_body) => {\n      logger.info('Website URL set');\n    })\n    .catch((err) => {\n      logger.error(`Website URL setting failed: ${err}`);\n      if (err.stack) {\n        logger.error(err.stack);\n      }\n      return err;\n    });\n  }\n\n  static subscribeWebhooks(page) {\n    let options = {\n      uri: `${constant.GRAPH_BASE_URL}/${constant.FB_APP_ID}/subscriptions`,\n      json: {\n        access_token: constant.FB_APP_ACCESS_TOKEN,\n        object: 'page',\n        callback_url: constant.HEROKU_APP_URL + constant.WEBHOOK_PATH,\n        fields: ['messages', 'messaging_postbacks'],\n        verify_token: constant.WEBHOOK_VERIFY_TOKEN\n      },\n    };\n    logger.info(`Subscribing webhook events with params: ${JSON.stringify(options.json)}`);\n\n    return fbrequest.post(options)\n      .then((_body) => {\n        logger.info('Subscribed webhook events successfully');\n        let params = {\n          access_token: page.access_token,\n        };\n        logger.info(`Subscribing page to app with params: ${JSON.stringify(params)}`);\n        return fbrequest.post({\n          uri: `${constant.GRAPH_BASE_URL}/${page.id}/subscribed_apps`,\n          json: params,\n        });\n      })\n      .then((_body) => {\n        logger.info('Subscribed page to app successfully');\n      })\n      .catch((err) => {\n        logger.error(`Failed to subscribed page to app: ${JSON.stringify(err)}`);\n        return err;\n      });\n  }\n}\n"]}